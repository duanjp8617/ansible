---
- name: Show bridge interface.
  become: yes
  command: "ip link show {{ vxlan.bridge_name }}"
  ignore_errors: yes
  register: show_bridge_interface

- fail: 
    msg: "bridge interface {{ vxlan.bridge_name }} is not present"
  when: show_bridge_interface.rc|int != 0

- name: Show vxlan interfaces.
  become: yes
  command: "ip link show vxlan{{ item.id }}"
  ignore_errors: yes
  register: show_vxlan_interfaces
  with_items: "{{ vxlan.remotes }}"

- fail: 
    msg: "vxlan interface vxlan{{ item.item.id }} is not present"
  when: item.rc|int != 0
  with_items: "{{ show_vxlan_interfaces.results }}"

- name: List existing VMs
  virt:
    command: list_vms
  register: list_vms

- fail: 
    msg: "vm{{ item.network_idx }} is present"
  when: ("vm" + item.network_idx|string) in list_vms.list_vms
  with_items: '{{ vms }}'

- name: Delete vxlan interfaces.
  become: yes
  command: "ip link delete vxlan{{ item.id }}"
  with_items: '{{ vxlan.remotes }}'

- name: Delete bridge interface.
  become: yes
  command: "ip link delete {{ vxlan.bridge_name }}"

